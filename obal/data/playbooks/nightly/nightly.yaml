---
- hosts:
    - packages
  serial: 1
  gather_facts: no
  vars:
    build_package_tito_releaser_args: "{{ nightly_package_tito_releaser_args | default('') }}"
  tasks:
    - name: Release a nightly package and rollback specfile
      block:
        - set_fact:
            releasers:
              - "{{ nightly_releaser }}"
          when: nightly_releaser is defined

        - set_fact:
            build_package_tito_releaser_args:
              - "{{ build_package_tito_releaser_args }} --arg rpmbuild_options=\"--define 'nightly .{{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}git{{ nightly_githash[:7] }}'\""

        - name: copy source files
          copy:
            src: "{{ item }}"
            dest: "{{ inventory_dir }}/{{ package_base_dir }}/{{ inventory_hostname }}/"
          with_items: "{{ nightly_sourcefiles.split(',') }}"

        - import_role:
            name: build_package
