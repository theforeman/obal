---
- hosts:
    - packages
  serial: 1
  gather_facts: no
  vars:
    build_package_tito_releaser_args: "{{ nightly_package_tito_releaser_args | default([]) }}"
  tasks:
    - name: 'set nightly_releaser'
      set_fact:
        releasers:
          - "{{ nightly_releaser }}"
      when: nightly_releaser is defined and '--arg jenkins_job=' in (build_package_tito_releaser_args | join(' '))

    - block:
      - name: 'set nightly_macro_args'
        set_fact:
          nightly_macro_args:
            - "--arg rpmbuild_options=\"--define 'nightly .{{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}git{{ nightly_githash[:7] }}'\""

      - name: 'append nightly_macro_args to build_package_tito_releaser_args'
        set_fact:
          build_package_tito_releaser_args: "{{ build_package_tito_releaser_args }} + {{ nightly_macro_args }}"

      - name: copy source files
        copy:
          src: "{{ item }}"
          dest: "{{ inventory_dir }}/{{ package_base_dir }}/{{ inventory_hostname }}/"
        with_items: "{{ nightly_sourcefiles }}"
      when: nightly_sourcefiles is defined and nightly_githash is defined
    # end block

    - import_role:
        name: build_package
