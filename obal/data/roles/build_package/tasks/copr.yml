---
- block:
    - name: 'Release to copr'
      tito_release:
        directory: "{{ inventory_dir }}/{{ package_base_dir }}/{{ inventory_hostname }}"
        arguments: "{{ build_package_tito_args }}"
        test: "{{ build_package_test }}"
        scratch: "{{ build_package_scratch }}"
        releasers: "{{ releasers }}"
        releaser_arguments: "{{ build_package_tito_releaser_args }}"
      register: build_package_tito_release

    - name: 'Wait for tasks to finish'
      include_tasks: wait.yml
      when: build_package_wait|bool
  when: not build_package_scratch

- block:
    - name: Define copr repo name
      set_fact:
        copr_repo_name: "{{ copr_user }}/{{ build_package_scratch_repo }}-{{ 999999999 | random | to_uuid }}"
      run_once: true
      when: copr_repo_name is not defined

    - name: 'Write copr repo name to vars file'
      copy:
        content: "{{ 'copr_repo: ' + copr_repo_name | to_yaml }}"
        dest: "{{ obal_tmp_dir }}/copr_repo"
        mode: 0640
      run_once: true

    - include_role:
        name: copr_repo
      run_once: true

    - name: 'Build SRPM'
      tito_build:
        directory: "{{ inventory_dir }}/{{ package_base_dir }}/{{ inventory_hostname }}"
        srpm: true
        scl: "{{ scl }}"
      register: srpm_build

    - name: 'Run build'
      command: >-
        copr-cli build
        {% if not build_package_wait | bool %}--nowait{% endif %}
        {{ copr_repo_name }}
        {{ srpm_build.path }}
      register: build_status

    - debug:
        msg: "{{ build_status.stdout_lines | join('\n') }}"
  when: build_package_scratch
