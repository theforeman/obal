---
- set_fact:
    source: "{{ item }}"
    sourcebase: "{{ item | basename }}"
  tags:
    - always

- set_fact:
    sourcepath: "{{ package_dir  }}/{{ sourcebase }}"
  tags:
    - always

- name: 'Source exists'
  stat:
    path: "{{ sourcepath }}"
  register: source_exists
  tags:
    - always

- name: 'Search annex for web link'
  shell: 'git annex whereis {{ sourcepath }} 2>/dev/null | grep -q " web:"'
  args:
    chdir: "{{ package_dir }}"
  changed_when: False
  register: search_annex
  ignore_errors: yes
  when: (not source_exists.stat.exists) or ( source_exists.stat.exists and source_exists.stat.islnk is defined and source_exists.stat.islnk )
  tags:
    - always

- name: 'Add url to annex for source'
  shell: "git annex addurl {{ setup_sources_annex_options }} --file '{{ sourcebase }}' '{{ source }}'"
  args:
    chdir: "{{ package_dir }}"
  ignore_errors: yes
  when: search_annex|failed
  tags:
    - always
